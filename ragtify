#!/bin/bash

# Ragtify Docker Management Script
# Usage: ./ragtify [up|down|build|restart|status|logs]

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOCKER_COMPOSE_FILE="$SCRIPT_DIR/.docker/docker-compose.yml"

# Check if Docker Compose file exists
if [ ! -f "$DOCKER_COMPOSE_FILE" ]; then
    echo -e "${RED}Error: Docker Compose file not found at $DOCKER_COMPOSE_FILE${NC}"
    exit 1
fi

# Function to print fancy RAGTIFY ASCII art
print_ragtify_banner() {
    clear
    echo -e "${CYAN}"
    cat << "EOF"
    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    ‚ïë                                                              ‚ïë
    ‚ïë    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó  ‚ïë
    ‚ïë    ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïë ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïî‚ïù  ‚ïë
    ‚ïë    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë         ‚ñà‚ñà‚ïë    ‚ñà‚ñà‚ïë ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó   ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù   ‚ïë
    ‚ïë    ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë    ‚ñà‚ñà‚ïë ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù    ‚ïö‚ñà‚ñà‚ïî‚ïù    ‚ïë
    ‚ïë    ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó    ‚ñà‚ñà‚ïë    ‚ñà‚ñà‚ïë ‚ñà‚ñà‚ïó        ‚ñà‚ñà‚ïë     ‚ïë
    ‚ïë    ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù    ‚ïö‚ïê‚ïù    ‚ïö‚ïê‚ïù ‚ïö‚ïê         ‚ïö‚ïê‚ïù     ‚ïë
    ‚ïë                                                              ‚ïë
    ‚ïë              üöÄ RAG-Powered Application Platform üöÄ          ‚ïë
    ‚ïë                                                              ‚ïë
    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
EOF
    echo -e "${NC}"
    
    # Animated loading dots
    echo -e "${YELLOW}Initializing Ragtify services...${NC}"
    for i in {1..3}; do
        printf "${GREEN}."
        sleep 0.5
    done
    printf "${NC}\n\n"
}

# Function to add domain entries to /etc/hosts
setup_domains() {
    echo -e "${BLUE}üîß Setting up local domains...${NC}"
    
    # Check if we can modify /etc/hosts
    if [ -w /etc/hosts ] || sudo -n true 2>/dev/null; then
        # Check if domains are already in hosts file
        if grep -q "ragtify.local" /etc/hosts 2>/dev/null; then
            echo -e "${YELLOW}‚ö†Ô∏è  ragtify.local already exists in /etc/hosts${NC}"
        else
            if [ -w /etc/hosts ]; then
                echo "127.0.0.1 ragtify.local" >> /etc/hosts
                echo -e "${GREEN}‚úÖ Added ragtify.local to /etc/hosts${NC}"
            else
                echo "127.0.0.1 ragtify.local" | sudo tee -a /etc/hosts > /dev/null 2>&1
                if [ $? -eq 0 ]; then
                    echo -e "${GREEN}‚úÖ Added ragtify.local to /etc/hosts${NC}"
                else
                    echo -e "${YELLOW}‚ö†Ô∏è  Could not add ragtify.local to /etc/hosts (permission denied)${NC}"
                    echo -e "${YELLOW}   You can manually add: 127.0.0.1 ragtify.local${NC}"
                fi
            fi
        fi
        
        if grep -q "api.ragtify.local" /etc/hosts 2>/dev/null; then
            echo -e "${YELLOW}‚ö†Ô∏è  api.ragtify.local already exists in /etc/hosts${NC}"
        else
            if [ -w /etc/hosts ]; then
                echo "127.0.0.1 api.ragtify.local" >> /etc/hosts
                echo -e "${GREEN}‚úÖ Added api.ragtify.local to /etc/hosts${NC}"
            else
                echo "127.0.0.1 api.ragtify.local" | sudo tee -a /etc/hosts > /dev/null 2>&1
                if [ $? -eq 0 ]; then
                    echo -e "${GREEN}‚úÖ Added api.ragtify.local to /etc/hosts${NC}"
                else
                    echo -e "${YELLOW}‚ö†Ô∏è  Could not add api.ragtify.local to /etc/hosts (permission denied)${NC}"
                    echo -e "${YELLOW}   You can manually add: 127.0.0.1 api.ragtify.local${NC}"
                fi
            fi
        fi
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Cannot modify /etc/hosts (no sudo access)${NC}"
        echo -e "${YELLOW}   Please manually add these lines to /etc/hosts:${NC}"
        echo -e "${YELLOW}   127.0.0.1 ragtify.local${NC}"
        echo -e "${YELLOW}   127.0.0.1 api.ragtify.local${NC}"
    fi
    
    echo ""
}

# Function to show service URLs
show_service_urls() {
    echo -e "${PURPLE}üåê Service URLs:${NC}"
    echo -e "${WHITE}  Frontend (Chat):${NC}     http://ragtify.local:3001"
    echo -e "${WHITE}  Backend API:${NC}         http://api.ragtify.local:8000"
    echo -e "${WHITE}  API Docs:${NC}            http://api.ragtify.local:8000/docs"
    echo -e "${WHITE}  Ollama:${NC}              http://localhost:11434"
    echo -e "${WHITE}  Qdrant:${NC}              http://localhost:6333"
    echo -e "${WHITE}  MySQL:${NC}               localhost:3307"
    echo ""
}

# Function to start services
start_services() {
    print_ragtify_banner
    setup_domains
    
    echo -e "${GREEN}üöÄ Starting Ragtify services...${NC}"
    echo -e "${YELLOW}This may take a few minutes on first run...${NC}\n"
    
    cd "$SCRIPT_DIR"
    docker compose -f "$DOCKER_COMPOSE_FILE" up -d --build
    
    echo -e "\n${GREEN}‚úÖ Services started successfully!${NC}"
    show_service_urls
    
    echo -e "${CYAN}üí° Tip: Use './ragtify logs' to view service logs${NC}"
    echo -e "${CYAN}üí° Tip: Use './ragtify down' to stop all services${NC}"
}

# Function to stop services
stop_services() {
    echo -e "${RED}üõë Stopping Ragtify services...${NC}"
    
    cd "$SCRIPT_DIR"
    docker compose -f "$DOCKER_COMPOSE_FILE" down --remove-orphans
    
    echo -e "${GREEN}‚úÖ Services stopped successfully!${NC}"
}

# Function to build services
build_services() {
    echo -e "${BLUE}üî® Building Ragtify services...${NC}"
    
    cd "$SCRIPT_DIR"
    docker compose -f "$DOCKER_COMPOSE_FILE" build --no-cache
    
    echo -e "${GREEN}‚úÖ Services built successfully!${NC}"
}

# Function to restart services
restart_services() {
    echo -e "${YELLOW}üîÑ Restarting Ragtify services...${NC}"
    stop_services
    sleep 2
    start_services
}

# Function to show service status
show_status() {
    echo -e "${PURPLE}üìä Ragtify Service Status:${NC}\n"
    
    cd "$SCRIPT_DIR"
    docker compose -f "$DOCKER_COMPOSE_FILE" ps
    
    echo ""
    show_service_urls
}

# Function to show logs
show_logs() {
    echo -e "${BLUE}üìã Showing Ragtify service logs...${NC}"
    echo -e "${YELLOW}Press Ctrl+C to exit${NC}\n"
    
    cd "$SCRIPT_DIR"
    docker compose -f "$DOCKER_COMPOSE_FILE" logs -f
}

# Function to show help
show_help() {
    echo -e "${WHITE}Ragtify Docker Management Script${NC}"
    echo -e "${CYAN}Usage: ./ragtify [command]${NC}\n"
    echo -e "${GREEN}Commands:${NC}"
    echo -e "  ${YELLOW}up${NC}        Start all services with fancy banner"
    echo -e "  ${YELLOW}down${NC}      Stop all services"
    echo -e "  ${YELLOW}build${NC}     Build all services (no cache)"
    echo -e "  ${YELLOW}restart${NC}   Restart all services"
    echo -e "  ${YELLOW}status${NC}    Show service status"
    echo -e "  ${YELLOW}logs${NC}      Show service logs (follow mode)"
    echo -e "  ${YELLOW}help${NC}      Show this help message"
    echo ""
    echo -e "${PURPLE}Examples:${NC}"
    echo -e "  ./ragtify up      # Start everything with animations"
    echo -e "  ./ragtify down    # Stop everything"
    echo -e "  ./ragtify logs    # View real-time logs"
}

# Main script logic
case "${1:-help}" in
    "up")
        start_services
        ;;
    "down")
        stop_services
        ;;
    "build")
        build_services
        ;;
    "restart")
        restart_services
        ;;
    "status")
        show_status
        ;;
    "logs")
        show_logs
        ;;
    "help"|"--help"|"-h")
        show_help
        ;;
    *)
        echo -e "${RED}‚ùå Unknown command: $1${NC}"
        echo ""
        show_help
        exit 1
        ;;
esac
